---
- name: Nectar JBrowse2 Setup on existing Apollo2
  hosts: all
  remote_user: ubuntu
  become: true
  become_flags: "-H -S" # -H forces sudo to simulate a login shell and reset HOME correctly, -S tells sudo to use the default security policy, donâ€™t attempt ACL operations
  become_method: sudo
  connection: "ssh"

  vars:
    node_version: "24"
    nvm_version: "v0.40.3"
    #jbrowse_version: "3.7.0" # override to use specific version instead of latest
    jbrowse_build_user: "{{ (apollo_subdomain_name ~ '_user') if apollo_subdomain_name is defined else 'ubuntu' }}" # use <subdomain>_user if defined, otherwise default to ubuntu
    apollo_internal_domain_name: >-
      {{ 'apollo-%03d.genome.edu.au' | format(apollo_instance_number|int)
         if apollo_instance_number is defined
         else '' }}
    apollo_custom_domain_name: >-
      {{ apollo_subdomain_name ~ '.genome.edu.au'
         if apollo_subdomain_name is defined
         else '' }}
    jbrowse_domain: "{{ apollo_internal_domain_name }}"

  tasks:
    - import_role:
        name: jbrowse-admin-users-groups
    - import_role:
        name: jbrowse2-dependencies
    - import_role:
        name: common-require-acl-support # Ansible needs setfacl when using become_user for non-root users
    - import_role:
        name: jbrowse-install-nvm-nodejs
    - import_role:
        name: jbrowse-install-yarn2 # requires NVM and Node.js installed first
    - import_role:
        name: jbrowse2-install-jbrowse-cli # requires NVM and Node.js installed first
    - import_role:
        name: jbrowse2-install-web
    - import_role:
        name: apollo-nginx-conf-add-jbrowse2

