---
- name: "Create apollo CLI user account {{ create_user_name }} with UID {{ create_user_id }}"
  user:
    name: "{{ create_user_name }}"
    shell: "/bin/bash"
    uid: "{{ create_user_id }}"
    state: "present"

- name: "Read /etc/ssh/sshd_config content"
  shell:
    cmd: "cat /etc/ssh/sshd_config"
  register: var_sshd_config

- set_fact:
    var_regex_sshd_config: "{{ var_sshd_config.stdout | regex_search('AllowGroups.*') }}"

- name: "Print AllowGroups entry from sshd_config"
  debug:
    msg: "{{ var_regex_sshd_config}}"

- name: "Append the CLI user's group (same as username) to /etc/ssh/sshd_config AllowGroups"
  lineinfile:
    dest: "/etc/ssh/sshd_config"
    regexp: "^AllowGroups"
    #line: "{{ var_regex_sshd_config }} {{ create_user_name }}" # not idempotent
    line: |
      AllowGroups {{ lookup('file', '/etc/ssh/sshd_config') | selectattr('key', 'equalto', 'AllowGroups') | map(attribute='value') | join(' ') }} {{ create_user_name }}
    state: present
  notify:
    - Restart ssh
