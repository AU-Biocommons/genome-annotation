# /etc/nginx/conf.d/default.conf
# Static JBrowse at /
# Reverse proxy to Apollo backend for /apollo/ and /config.json

# Helpful for WebSocket "Connection" header handling
map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

upstream apollo_backend {
  server apollo-collaboration-server:3999;
  keepalive 16;
}

server {
  listen 80;
  server_name _;

  # Serve JBrowse static assets from here
  root /usr/share/nginx/html;
  index index.html;

  # Allow large uploads to pass through to Apollo
  client_max_body_size 512m;

  # Basic hardening/headers (optional)
  add_header X-Content-Type-Options nosniff;
  add_header X-Frame-Options SAMEORIGIN;

  # ProxyPass of /config.json
  location = /config.json {
    proxy_set_header Host $host;
    proxy_pass http://apollo_backend/jbrowse/config.json;
    proxy_redirect off;
  }

  # treat both /apollo and /apollo/ as healthy
  location = /apollo { return 204; add_header Cache-Control no-store; }
  location = /apollo/ { return 204; add_header Cache-Control no-store; }

  # Apollo reverse proxy with WebSocket & long timeouts
  location /apollo/ {
    proxy_http_version 1.1;

    # WebSocket upgrade
    proxy_set_header Upgrade             $http_upgrade;
    proxy_set_header Connection          $connection_upgrade;

    # preserve public context from the edge
    proxy_set_header Host                $host;
    proxy_set_header X-Forwarded-Proto   $http_x_forwarded_proto;
    proxy_set_header X-Forwarded-Host    $http_x_forwarded_host;
    proxy_set_header X-Forwarded-Port    $http_x_forwarded_port;

    # optional (some apps use it when a prefix is stripped)
    proxy_set_header X-Forwarded-Prefix  /apollo;

    # Client IP chain
    proxy_set_header X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP           $remote_addr;

    # Helpful for streaming/SSE; safe to disable buffering here
    proxy_buffering off;

    # Long timeouts
    proxy_connect_timeout 3600s;
    proxy_send_timeout    3600s;
    proxy_read_timeout    3600s;

    proxy_pass http://apollo_backend/;
    proxy_redirect off;
  }

  # Static files (JBrowse)
  location / {
    try_files $uri $uri/ /index.html;
  }
}

